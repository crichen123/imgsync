language: go

os: linux
dist: bionic
go: 1.14.x

cache:
  directories:
    - ${HOME}/.cache/go-build
    - ${HOME}/manifests
    - ${GOPATH}/pkg/mod
    - ${GOPATH}/bin

stages:
  - Build imgsync
  - Fetch Manifests
  - Sync Kubeadm
  - Sync Flannel
  - Sync Helm
  - Sync Istio
  - Sync Distroless
  - Sync Samples
  - Sync Linkerd
  - Sync Spinnaker

jobs:
  include:
    - stage: Build imgsync
      script:
        - make install
    - stage: Fetch Manifests
      script:
        - rm -rf ${HOME}/manifests
        - git clone https://mritd:${GITHUB_TOKEN}@github.com/mritd/gcr.git ${HOME}/manifests
    - stage: Sync Kubeadm
      script:
        - imgsync gcr --kubeadm --user ${DOCKER_USER} --password ${DOCKER_PASSWORD} --processlimit 40 --manifests ${HOME}/manifests
    - stage: Sync Flannel
      script:
        - imgsync flannel --user ${DOCKER_USER} --password ${DOCKER_PASSWORD} --processlimit 40 --manifests ${HOME}/manifests
    - stage: Sync Helm
      script:
        - imgsync gcr --namespace kubernetes-helm --user ${DOCKER_USER} --password ${DOCKER_PASSWORD} --processlimit 40 --manifests ${HOME}/manifests
    - stage: Sync Istio
      script:
        - imgsync gcr --namespace istio-release --user ${DOCKER_USER} --password ${DOCKER_PASSWORD} --processlimit 40 --manifests ${HOME}/manifests
    - stage: Sync Distroless
      script:
        - imgsync gcr --namespace distroless --user ${DOCKER_USER} --password ${DOCKER_PASSWORD} --processlimit 40 --manifests ${HOME}/manifests
    - stage: Sync Samples
      script:
        - imgsync gcr --namespace google-samples --user ${DOCKER_USER} --password ${DOCKER_PASSWORD} --processlimit 40 --manifests ${HOME}/manifests
    - stage: Sync Linkerd
      script:
        - imgsync gcr --namespace linkerd-io --user ${DOCKER_USER} --password ${DOCKER_PASSWORD} --processlimit 40 --manifests ${HOME}/manifests
    - stage: Sync Spinnaker
      script:
        - imgsync gcr --namespace spinnaker-marketplace --user ${DOCKER_USER} --password ${DOCKER_PASSWORD} --processlimit 40 --manifests ${HOME}/manifests

after_success: |
  export TZ=UTC-8
  cd ${HOME}/manifests
  if [ ! git diff-index --quiet HEAD -- ]; then
    git add .
    git commit -m "Travis CI Auto Update(`date +'%Y-%m-%d %H:%M:%S'`)"
    git push https://mritd:${GITHUB_TOKEN}@github.com/mritd/gcr.git
  fi
